name: Run Scoring Service

on:
  # Triggered after complexity scoring completes
  workflow_run:
    workflows: ["Score Complexity Predictions"]
    types: [completed]
    branches: [main]

  workflow_dispatch:
    inputs:
      start_year:
        description: 'Start year for predictions'
        required: false
        default: '2025'
      end_year:
        description: 'End year for predictions'
        required: false
        default: '2030'
      output_path:
        description: 'Cloud storage path for predictions (optional)'
        required: false
        default: ''
      use_change_detection:
        description: 'Only score games with changed features'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Keep schedule as fallback during transition
  schedule:
    - cron: '0 7 * * *'

env:
  GCP_PROJECT_ID: bgg-predictive-models

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'PROD' || 'DEV' }}

    permissions:
      contents: read
      id-token: write

    outputs:
      env_tag: ${{ steps.env-tag.outputs.env_tag }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set Environment Tag
      id: env-tag
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "env_tag=prod" >> $GITHUB_OUTPUT
        else
          echo "env_tag=dev" >> $GITHUB_OUTPUT
        fi

  # Removed get-latest-models job since model names now come from config

  trigger-predictions:
    needs: [setup]
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'PROD' || 'DEV' }}
    # Skip if triggered by workflow_run and upstream failed
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_BGG_ML }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Setup Python with UV
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install requests google-cloud-storage python-dotenv

    - name: Get Service URL
      id: get-url
      run: |
        SERVICE_URL=$(gcloud run services describe bgg-model-scoring \
          --region us-central1 \
          --format 'value(status.url)')
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

    - name: Setup Environment
      run: |
        cat << EOF > .env
        GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }}
        ENVIRONMENT=${{ needs.setup.outputs.env_tag }}
        EOF

    - name: Trigger Predictions using score.py
      run: |
        USE_CHANGE_DETECTION="${{ github.event.inputs.use_change_detection || 'true' }}"

        CHANGE_DETECTION_FLAG=""
        if [ "$USE_CHANGE_DETECTION" = "true" ]; then
          CHANGE_DETECTION_FLAG="--use-change-detection"
        fi

        uv run -m scoring_service.score \
          --service-url "${{ steps.get-url.outputs.service_url }}" \
          --start-year ${{ github.event.inputs.start_year || 2024 }} \
          --end-year ${{ github.event.inputs.end_year || 2029 }} \
          --upload-to-bigquery \
          $CHANGE_DETECTION_FLAG \
          ${{ github.event.inputs.output_path != '' && format('--output-path "{0}"', github.event.inputs.output_path) || '' }}

    - name: Log Prediction Metadata
      run: |
        echo "Prediction Parameters:"
        echo "Environment: ${{ needs.setup.outputs.env_tag }}"
        echo "Start Year: ${{ github.event.inputs.start_year || 2024 }}"
        echo "End Year: ${{ github.event.inputs.end_year || 2029 }}"
        echo "Output Path: ${{ github.event.inputs.output_path || 'Using environment default' }}"
        echo "Using model names from config.yaml"
