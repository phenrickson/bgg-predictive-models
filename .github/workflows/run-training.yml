name: Run Model Training

on:
  push:
    branches:
      - 'model/*'
  workflow_dispatch:
    inputs:
      start_year:
        description: 'Start year for evaluation'
        required: false
        default: '2020'
        type: string
      end_year:
        description: 'End year for evaluation'
        required: false
        default: '2021'
        type: string
      output_dir:
        description: 'Output directory path (default: models/experiments)'
        required: false
        default: 'models/experiments'
        type: string
      model_args:
        description: 'Model arguments (space-separated list of model.key=value)'
        required: false
        type: string

jobs:
  run-training:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'PROD' || 'DEV' }}
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.SERVICE_ACCOUNT_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Google Cloud Docker Auth
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Setup for training
      run: |
        # Create credentials directory and save service account key
        mkdir -p credentials
        echo '${{ secrets.SERVICE_ACCOUNT_KEY }}' > credentials/service-account-key.json

    - name: Run Training
      run: |
        # Construct GCS output path
        GCS_OUTPUT_PATH="gs://${{ vars.GCS_BUCKET_NAME }}/${{ inputs.output_dir }}"
        
        docker run \
          -e GCP_PROJECT_ID=${{ vars.GCP_PROJECT_ID }} \
          -e GCS_BUCKET_NAME=${{ vars.GCS_BUCKET_NAME }} \
          -e GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account-key.json \
          -v ./credentials:/app/credentials \
          us-central1-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/bgg-predictive-models/training:latest \
          uv run train.py \
            --start-year ${{ inputs.start_year }} \
            --end-year ${{ inputs.end_year }} \
            --output-dir "${GCS_OUTPUT_PATH}" \
            ${{ inputs.model_args != '' && format('--model-args {0}', inputs.model_args) || '' }}
